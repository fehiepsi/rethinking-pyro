<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="rethinking.py">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>rethinking.py | Statistical Rethinking with PyTorch and Pyro</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="https://fehiepsi.github.io/rethinking-pyro/code/rethinking.py.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../">

            <span id="blog-title">Statistical Rethinking with PyTorch and Pyro</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../" class="nav-link">Contents</a>
                </li>
<li class="nav-item">
<a href="https://fehiepsi.github.io" class="nav-link">Blog</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        

<nav class="breadcrumbs"><ul class="breadcrumb">
<li class="breadcrumb-item"><a href=".">code</a></li>
                <li class="breadcrumb-item active">rethinking.py</li>
</ul></nav><h1>rethinking.py
        <small><a href="rethinking.py">(Source)</a></small>
    </h1>
    <div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-1"><code data-line-number="  1"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-1" name="listingsrethinkingpy-1"></a><span class="kn">import</span> <span class="nn">inspect</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-2"><code data-line-number="  2"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-2" name="listingsrethinkingpy-2"></a><span class="kn">import</span> <span class="nn">os</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-3"><code data-line-number="  3"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-3" name="listingsrethinkingpy-3"></a><span class="kn">import</span> <span class="nn">re</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-4"><code data-line-number="  4"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-4" name="listingsrethinkingpy-4"></a><span class="kn">import</span> <span class="nn">warnings</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-5"><code data-line-number="  5"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-5" name="listingsrethinkingpy-5"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-6"><code data-line-number="  6"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-6" name="listingsrethinkingpy-6"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-7"><code data-line-number="  7"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-7" name="listingsrethinkingpy-7"></a><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-8"><code data-line-number="  8"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-8" name="listingsrethinkingpy-8"></a><span class="kn">import</span> <span class="nn">torch</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-9"><code data-line-number="  9"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-9" name="listingsrethinkingpy-9"></a><span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-10"><code data-line-number=" 10"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-10" name="listingsrethinkingpy-10"></a><span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">transform_to</span><span class="p">,</span> <span class="n">constraints</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-11"><code data-line-number=" 11"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-11" name="listingsrethinkingpy-11"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-12"><code data-line-number=" 12"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-12" name="listingsrethinkingpy-12"></a><span class="kn">import</span> <span class="nn">pyro</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-13"><code data-line-number=" 13"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-13" name="listingsrethinkingpy-13"></a><span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-14"><code data-line-number=" 14"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-14" name="listingsrethinkingpy-14"></a><span class="kn">import</span> <span class="nn">pyro.ops.stats</span> <span class="k">as</span> <span class="nn">stats</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-15"><code data-line-number=" 15"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-15" name="listingsrethinkingpy-15"></a><span class="kn">import</span> <span class="nn">pyro.poutine</span> <span class="k">as</span> <span class="nn">poutine</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-16"><code data-line-number=" 16"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-16" name="listingsrethinkingpy-16"></a><span class="kn">from</span> <span class="nn">pyro.contrib.autoguide</span> <span class="kn">import</span> <span class="n">AutoLaplaceApproximation</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-17"><code data-line-number=" 17"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-17" name="listingsrethinkingpy-17"></a><span class="kn">from</span> <span class="nn">pyro.infer</span> <span class="kn">import</span> <span class="n">TracePosterior</span><span class="p">,</span> <span class="n">TracePredictive</span><span class="p">,</span> <span class="n">Trace_ELBO</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-18"><code data-line-number=" 18"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-18" name="listingsrethinkingpy-18"></a><span class="kn">from</span> <span class="nn">pyro.infer.mcmc</span> <span class="kn">import</span> <span class="n">MCMC</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-19"><code data-line-number=" 19"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-19" name="listingsrethinkingpy-19"></a><span class="kn">from</span> <span class="nn">pyro.ops.welford</span> <span class="kn">import</span> <span class="n">WelfordCovariance</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-20"><code data-line-number=" 20"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-20" name="listingsrethinkingpy-20"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-21"><code data-line-number=" 21"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-21" name="listingsrethinkingpy-21"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"CUDA_VISIBLE_DEVICES"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">""</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-22"><code data-line-number=" 22"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-22" name="listingsrethinkingpy-22"></a><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-23"><code data-line-number=" 23"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-23" name="listingsrethinkingpy-23"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-24"><code data-line-number=" 24"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-24" name="listingsrethinkingpy-24"></a><span class="n">mp</span><span class="o">.</span><span class="n">set_sharing_strategy</span><span class="p">(</span><span class="s2">"file_system"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-25"><code data-line-number=" 25"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-25" name="listingsrethinkingpy-25"></a><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)})</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-26"><code data-line-number=" 26"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-26" name="listingsrethinkingpy-26"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-27"><code data-line-number=" 27"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-27" name="listingsrethinkingpy-27"></a><span class="n">pyro</span><span class="o">.</span><span class="n">enable_validation</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-28"><code data-line-number=" 28"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-28" name="listingsrethinkingpy-28"></a><span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-29"><code data-line-number=" 29"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-29" name="listingsrethinkingpy-29"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-30"><code data-line-number=" 30"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-30" name="listingsrethinkingpy-30"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-31"><code data-line-number=" 31"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-31" name="listingsrethinkingpy-31"></a><span class="k">class</span> <span class="nc">MAP</span><span class="p">(</span><span class="n">TracePosterior</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-32"><code data-line-number=" 32"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-32" name="listingsrethinkingpy-32"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">{}):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-33"><code data-line-number=" 33"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-33" name="listingsrethinkingpy-33"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MAP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-34"><code data-line-number=" 34"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-34" name="listingsrethinkingpy-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-35"><code data-line-number=" 35"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-35" name="listingsrethinkingpy-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-36"><code data-line-number=" 36"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-36" name="listingsrethinkingpy-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-37"><code data-line-number=" 37"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-37" name="listingsrethinkingpy-37"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-38"><code data-line-number=" 38"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-38" name="listingsrethinkingpy-38"></a>    <span class="k">def</span> <span class="nf">_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-39"><code data-line-number=" 39"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-39" name="listingsrethinkingpy-39"></a>        <span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-40"><code data-line-number=" 40"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-40" name="listingsrethinkingpy-40"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-41"><code data-line-number=" 41"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-41" name="listingsrethinkingpy-41"></a>        <span class="c1"># find good initial trace</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-42"><code data-line-number=" 42"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-42" name="listingsrethinkingpy-42"></a>        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-43"><code data-line-number=" 43"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-43" name="listingsrethinkingpy-43"></a>        <span class="n">best_log_prob</span> <span class="o">=</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">log_prob_sum</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-44"><code data-line-number=" 44"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-44" name="listingsrethinkingpy-44"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-45"><code data-line-number=" 45"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-45" name="listingsrethinkingpy-45"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-46"><code data-line-number=" 46"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-46" name="listingsrethinkingpy-46"></a>            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">log_prob_sum</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-47"><code data-line-number=" 47"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-47" name="listingsrethinkingpy-47"></a>            <span class="k">if</span> <span class="n">log_prob</span> <span class="o">&gt;</span> <span class="n">best_log_prob</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-48"><code data-line-number=" 48"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-48" name="listingsrethinkingpy-48"></a>                <span class="n">best_log_prob</span> <span class="o">=</span> <span class="n">log_prob</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-49"><code data-line-number=" 49"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-49" name="listingsrethinkingpy-49"></a>                <span class="n">model_trace</span> <span class="o">=</span> <span class="n">trace</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-50"><code data-line-number=" 50"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-50" name="listingsrethinkingpy-50"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-51"><code data-line-number=" 51"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-51" name="listingsrethinkingpy-51"></a>        <span class="c1"># lift model</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-52"><code data-line-number=" 52"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-52" name="listingsrethinkingpy-52"></a>        <span class="n">model_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">prune_subsample_sites</span><span class="p">(</span><span class="n">model_trace</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-53"><code data-line-number=" 53"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-53" name="listingsrethinkingpy-53"></a>        <span class="n">prior</span><span class="p">,</span> <span class="n">unpacked</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-54"><code data-line-number=" 54"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-54" name="listingsrethinkingpy-54"></a>        <span class="n">param_constraints</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="s2">"constraints"</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-55"><code data-line-number=" 55"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-55" name="listingsrethinkingpy-55"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">model_trace</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-56"><code data-line-number=" 56"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-56" name="listingsrethinkingpy-56"></a>            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"param"</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-57"><code data-line-number=" 57"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-57" name="listingsrethinkingpy-57"></a>                <span class="k">if</span> <span class="n">param_constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-58"><code data-line-number=" 58"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-58" name="listingsrethinkingpy-58"></a>                    <span class="n">prior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-59"><code data-line-number=" 59"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-59" name="listingsrethinkingpy-59"></a>                <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-60"><code data-line-number=" 60"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-60" name="listingsrethinkingpy-60"></a>                    <span class="n">prior</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-61"><code data-line-number=" 61"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-61" name="listingsrethinkingpy-61"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">unconstrained</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-62"><code data-line-number=" 62"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-62" name="listingsrethinkingpy-62"></a>            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-63"><code data-line-number=" 63"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-63" name="listingsrethinkingpy-63"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-64"><code data-line-number=" 64"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-64" name="listingsrethinkingpy-64"></a>            <span class="k">elif</span> <span class="n">node</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"sample"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="p">[</span><span class="s2">"is_observed"</span><span class="p">]:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-65"><code data-line-number=" 65"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-65" name="listingsrethinkingpy-65"></a>                <span class="n">unpacked</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform_to</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">support</span><span class="p">)</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"value"</span><span class="p">])</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-66"><code data-line-number=" 66"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-66" name="listingsrethinkingpy-66"></a>        <span class="n">lifted_model</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">prior</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-67"><code data-line-number=" 67"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-67" name="listingsrethinkingpy-67"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-68"><code data-line-number=" 68"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-68" name="listingsrethinkingpy-68"></a>        <span class="c1"># define guide</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-69"><code data-line-number=" 69"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-69" name="listingsrethinkingpy-69"></a>        <span class="n">packed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">unpacked</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-70"><code data-line-number=" 70"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-70" name="listingsrethinkingpy-70"></a>        <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">"auto_loc"</span><span class="p">,</span> <span class="n">packed</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-71"><code data-line-number=" 71"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-71" name="listingsrethinkingpy-71"></a>        <span class="n">delta_guide</span> <span class="o">=</span> <span class="n">AutoLaplaceApproximation</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-72"><code data-line-number=" 72"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-72" name="listingsrethinkingpy-72"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-73"><code data-line-number=" 73"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-73" name="listingsrethinkingpy-73"></a>        <span class="c1"># train guide</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-74"><code data-line-number=" 74"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-74" name="listingsrethinkingpy-74"></a>        <span class="n">loc_param</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">"auto_loc"</span><span class="p">)</span><span class="o">.</span><span class="n">unconstrained</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-75"><code data-line-number=" 75"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-75" name="listingsrethinkingpy-75"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">((</span><span class="n">loc_param</span><span class="p">,),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-76"><code data-line-number=" 76"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-76" name="listingsrethinkingpy-76"></a>        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">Trace_ELBO</span><span class="p">()</span><span class="o">.</span><span class="n">differentiable_loss</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-77"><code data-line-number=" 77"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-77" name="listingsrethinkingpy-77"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-78"><code data-line-number=" 78"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-78" name="listingsrethinkingpy-78"></a>        <span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-79"><code data-line-number=" 79"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-79" name="listingsrethinkingpy-79"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-80"><code data-line-number=" 80"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-80" name="listingsrethinkingpy-80"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">,</span> <span class="n">delta_guide</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-81"><code data-line-number=" 81"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-81" name="listingsrethinkingpy-81"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-82"><code data-line-number=" 82"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-82" name="listingsrethinkingpy-82"></a>            <span class="k">return</span> <span class="n">loss</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-83"><code data-line-number=" 83"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-83" name="listingsrethinkingpy-83"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-84"><code data-line-number=" 84"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-84" name="listingsrethinkingpy-84"></a>        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-85"><code data-line-number=" 85"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-85" name="listingsrethinkingpy-85"></a>        <span class="n">guide</span> <span class="o">=</span> <span class="n">delta_guide</span><span class="o">.</span><span class="n">laplace_approximation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-86"><code data-line-number=" 86"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-86" name="listingsrethinkingpy-86"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-87"><code data-line-number=" 87"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-87" name="listingsrethinkingpy-87"></a>        <span class="c1"># get posterior</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-88"><code data-line-number=" 88"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-88" name="listingsrethinkingpy-88"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-89"><code data-line-number=" 89"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-89" name="listingsrethinkingpy-89"></a>            <span class="n">guide_trace</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">guide</span><span class="p">)</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-90"><code data-line-number=" 90"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-90" name="listingsrethinkingpy-90"></a>            <span class="n">model_poutine</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">replay</span><span class="p">(</span><span class="n">lifted_model</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">guide_trace</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-91"><code data-line-number=" 91"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-91" name="listingsrethinkingpy-91"></a>            <span class="k">yield</span> <span class="n">model_poutine</span><span class="o">.</span><span class="n">get_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="mf">1.0</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-92"><code data-line-number=" 92"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-92" name="listingsrethinkingpy-92"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-93"><code data-line-number=" 93"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-93" name="listingsrethinkingpy-93"></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-94"><code data-line-number=" 94"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-94" name="listingsrethinkingpy-94"></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-95"><code data-line-number=" 95"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-95" name="listingsrethinkingpy-95"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"error"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-96"><code data-line-number=" 96"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-96" name="listingsrethinkingpy-96"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-97"><code data-line-number=" 97"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-97" name="listingsrethinkingpy-97"></a>                <span class="k">try</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-98"><code data-line-number=" 98"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-98" name="listingsrethinkingpy-98"></a>                    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MAP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-99"><code data-line-number=" 99"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-99" name="listingsrethinkingpy-99"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-100"><code data-line-number="100"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-100" name="listingsrethinkingpy-100"></a>                    <span class="n">last_error</span> <span class="o">=</span> <span class="n">e</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-101"><code data-line-number="101"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-101" name="listingsrethinkingpy-101"></a>        <span class="k">raise</span> <span class="n">last_error</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-102"><code data-line-number="102"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-102" name="listingsrethinkingpy-102"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-103"><code data-line-number="103"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-103" name="listingsrethinkingpy-103"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-104"><code data-line-number="104"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-104" name="listingsrethinkingpy-104"></a><span class="k">def</span> <span class="nf">_formula_to_predictors</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-105"><code data-line-number="105"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-105" name="listingsrethinkingpy-105"></a>    <span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-106"><code data-line-number="106"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-106" name="listingsrethinkingpy-106"></a>    <span class="n">y_name</span><span class="p">,</span> <span class="n">expr_str</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" ~ "</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-107"><code data-line-number="107"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-107" name="listingsrethinkingpy-107"></a>    <span class="n">y_node</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">y_name</span><span class="p">,</span> <span class="s2">"value"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">y_name</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-108"><code data-line-number="108"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-108" name="listingsrethinkingpy-108"></a>    <span class="n">y_node</span><span class="p">[</span><span class="s2">"mean"</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_node</span><span class="p">[</span><span class="s2">"value"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-109"><code data-line-number="109"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-109" name="listingsrethinkingpy-109"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-110"><code data-line-number="110"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-110" name="listingsrethinkingpy-110"></a>    <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">True</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-111"><code data-line-number="111"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-111" name="listingsrethinkingpy-111"></a>    <span class="n">predictors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Intercept"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-112"><code data-line-number="112"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-112" name="listingsrethinkingpy-112"></a>    <span class="n">col_to_num</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-113"><code data-line-number="113"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-113" name="listingsrethinkingpy-113"></a>    <span class="n">expr_list</span> <span class="o">=</span> <span class="n">expr_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" + "</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-114"><code data-line-number="114"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-114" name="listingsrethinkingpy-114"></a>    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expr_list</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-115"><code data-line-number="115"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-115" name="listingsrethinkingpy-115"></a>        <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="s2">"0"</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-116"><code data-line-number="116"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-116" name="listingsrethinkingpy-116"></a>            <span class="n">fit_intercept</span> <span class="o">=</span> <span class="kc">False</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-117"><code data-line-number="117"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-117" name="listingsrethinkingpy-117"></a>        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"I"</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-118"><code data-line-number="118"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-118" name="listingsrethinkingpy-118"></a>            <span class="n">org_expr</span> <span class="o">=</span> <span class="n">expr</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-119"><code data-line-number="119"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-119" name="listingsrethinkingpy-119"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_to_num</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-120"><code data-line-number="120"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-120" name="listingsrethinkingpy-120"></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">"c</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col_to_num</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-121"><code data-line-number="121"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-121" name="listingsrethinkingpy-121"></a>            <span class="n">eval_expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">"I"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-122"><code data-line-number="122"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-122" name="listingsrethinkingpy-122"></a>            <span class="n">eval_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"c</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-123"><code data-line-number="123"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-123" name="listingsrethinkingpy-123"></a>            <span class="n">predictors</span><span class="p">[</span><span class="n">org_expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">eval_expr</span><span class="p">,</span> <span class="n">eval_map</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-124"><code data-line-number="124"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-124" name="listingsrethinkingpy-124"></a>        <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"C"</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-125"><code data-line-number="125"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-125" name="listingsrethinkingpy-125"></a>            <span class="n">cat_col</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-126"><code data-line-number="126"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-126" name="listingsrethinkingpy-126"></a>            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-127"><code data-line-number="127"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-127" name="listingsrethinkingpy-127"></a>                <span class="n">predictors</span><span class="p">[</span><span class="s2">"C(d)</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat</span><span class="p">)]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">cat_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">cat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-128"><code data-line-number="128"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-128" name="listingsrethinkingpy-128"></a>        <span class="k">elif</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-129"><code data-line-number="129"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-129" name="listingsrethinkingpy-129"></a>            <span class="n">predictors</span><span class="p">[</span><span class="n">expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">expr</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-130"><code data-line-number="130"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-130" name="listingsrethinkingpy-130"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-131"><code data-line-number="131"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-131" name="listingsrethinkingpy-131"></a>    <span class="k">if</span> <span class="n">fit_intercept</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-132"><code data-line-number="132"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-132" name="listingsrethinkingpy-132"></a>        <span class="n">predictors</span><span class="p">[</span><span class="s2">"Intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-133"><code data-line-number="133"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-133" name="listingsrethinkingpy-133"></a>    <span class="k">return</span> <span class="n">y_node</span><span class="p">,</span> <span class="n">predictors</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-134"><code data-line-number="134"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-134" name="listingsrethinkingpy-134"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-135"><code data-line-number="135"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-135" name="listingsrethinkingpy-135"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-136"><code data-line-number="136"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-136" name="listingsrethinkingpy-136"></a><span class="k">class</span> <span class="nc">LM</span><span class="p">(</span><span class="n">MAP</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-137"><code data-line-number="137"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-137" name="listingsrethinkingpy-137"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">{},</span> <span class="n">centering</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-138"><code data-line-number="138"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-138" name="listingsrethinkingpy-138"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-139"><code data-line-number="139"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-139" name="listingsrethinkingpy-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">y_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span> <span class="o">=</span> <span class="n">_formula_to_predictors</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-140"><code data-line-number="140"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-140" name="listingsrethinkingpy-140"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">predictor</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-141"><code data-line-number="141"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-141" name="listingsrethinkingpy-141"></a>                                 <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">"Intercept"</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-142"><code data-line-number="142"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-142" name="listingsrethinkingpy-142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">centering</span> <span class="o">=</span> <span class="n">centering</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-143"><code data-line-number="143"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-143" name="listingsrethinkingpy-143"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-144"><code data-line-number="144"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-144" name="listingsrethinkingpy-144"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-145"><code data-line-number="145"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-145" name="listingsrethinkingpy-145"></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-146"><code data-line-number="146"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-146" name="listingsrethinkingpy-146"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-147"><code data-line-number="147"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-147" name="listingsrethinkingpy-147"></a>            <span class="n">y_node</span><span class="p">,</span> <span class="n">predictors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-148"><code data-line-number="148"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-148" name="listingsrethinkingpy-148"></a>        <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-149"><code data-line-number="149"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-149" name="listingsrethinkingpy-149"></a>            <span class="n">y_node</span><span class="p">,</span> <span class="n">predictors</span> <span class="o">=</span> <span class="n">_formula_to_predictors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-150"><code data-line-number="150"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-150" name="listingsrethinkingpy-150"></a>        <span class="n">fit_intercept</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"Intercept"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-151"><code data-line-number="151"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-151" name="listingsrethinkingpy-151"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-152"><code data-line-number="152"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-152" name="listingsrethinkingpy-152"></a>        <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-153"><code data-line-number="153"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-153" name="listingsrethinkingpy-153"></a>        <span class="k">if</span> <span class="n">fit_intercept</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-154"><code data-line-number="154"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-154" name="listingsrethinkingpy-154"></a>            <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">"Intercept"</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">y_node</span><span class="p">[</span><span class="s2">"mean"</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-155"><code data-line-number="155"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-155" name="listingsrethinkingpy-155"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-156"><code data-line-number="156"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-156" name="listingsrethinkingpy-156"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="n">predictors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-157"><code data-line-number="157"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-157" name="listingsrethinkingpy-157"></a>            <span class="n">coef</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-158"><code data-line-number="158"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-158" name="listingsrethinkingpy-158"></a>            <span class="k">if</span> <span class="n">fit_intercept</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">centering</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-159"><code data-line-number="159"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-159" name="listingsrethinkingpy-159"></a>                <span class="c1"># use "centering trick"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-160"><code data-line-number="160"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-160" name="listingsrethinkingpy-160"></a>                <span class="n">predictor</span> <span class="o">=</span> <span class="n">predictor</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-161"><code data-line-number="161"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-161" name="listingsrethinkingpy-161"></a>            <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">coef</span> <span class="o">*</span> <span class="n">predictor</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-162"><code data-line-number="162"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-162" name="listingsrethinkingpy-162"></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">"sigma"</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfCauchy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-163"><code data-line-number="163"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-163" name="listingsrethinkingpy-163"></a>        <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">"plate"</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-164"><code data-line-number="164"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-164" name="listingsrethinkingpy-164"></a>            <span class="k">return</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">y_node</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y_node</span><span class="p">[</span><span class="s2">"value"</span><span class="p">])</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-165"><code data-line-number="165"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-165" name="listingsrethinkingpy-165"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-166"><code data-line-number="166"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-166" name="listingsrethinkingpy-166"></a>    <span class="k">def</span> <span class="nf">_get_centering_constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefs</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-167"><code data-line-number="167"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-167" name="listingsrethinkingpy-167"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-168"><code data-line-number="168"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-168" name="listingsrethinkingpy-168"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">predictor_mean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictor_means</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-169"><code data-line-number="169"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-169" name="listingsrethinkingpy-169"></a>            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">coefs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">predictor_mean</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-170"><code data-line-number="170"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-170" name="listingsrethinkingpy-170"></a>        <span class="k">return</span> <span class="n">center</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-171"><code data-line-number="171"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-171" name="listingsrethinkingpy-171"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-172"><code data-line-number="172"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-172" name="listingsrethinkingpy-172"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-173"><code data-line-number="173"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-173" name="listingsrethinkingpy-173"></a><span class="k">def</span> <span class="nf">glimmer</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-174"><code data-line-number="174"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-174" name="listingsrethinkingpy-174"></a>    <span class="n">y_node</span><span class="p">,</span> <span class="n">predictors</span> <span class="o">=</span> <span class="n">_formula_to_predictors</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-175"><code data-line-number="175"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-175" name="listingsrethinkingpy-175"></a>    <span class="n">fit_intercept</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"Intercept"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-176"><code data-line-number="176"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-176" name="listingsrethinkingpy-176"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"def model(</span><span class="si">{}</span><span class="s2">):"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predictors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="s2">", </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_node</span><span class="p">[</span><span class="s2">"name"</span><span class="p">])))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-177"><code data-line-number="177"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-177" name="listingsrethinkingpy-177"></a>    <span class="n">mu_str</span> <span class="o">=</span> <span class="s2">"    mu = "</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-178"><code data-line-number="178"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-178" name="listingsrethinkingpy-178"></a>    <span class="k">if</span> <span class="n">fit_intercept</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-179"><code data-line-number="179"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-179" name="listingsrethinkingpy-179"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"    intercept = pyro.sample('Intercept', dist.Normal(0, 10))"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-180"><code data-line-number="180"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-180" name="listingsrethinkingpy-180"></a>        <span class="n">mu_str</span> <span class="o">+=</span> <span class="s2">"intercept + "</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-181"><code data-line-number="181"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-181" name="listingsrethinkingpy-181"></a>    <span class="k">for</span> <span class="n">predictor</span> <span class="ow">in</span> <span class="n">predictors</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-182"><code data-line-number="182"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-182" name="listingsrethinkingpy-182"></a>        <span class="n">coef</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"**"</span><span class="p">,</span> <span class="s2">"_POW_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"*"</span><span class="p">,</span> <span class="s2">"_MUL_"</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-183"><code data-line-number="183"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-183" name="listingsrethinkingpy-183"></a>        <span class="n">coef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">"\W"</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-184"><code data-line-number="184"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-184" name="listingsrethinkingpy-184"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">"    b_</span><span class="si">{}</span><span class="s2"> = pyro.sample('</span><span class="si">{}</span><span class="s2">', dist.Normal(0, 10))"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">predictor</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-185"><code data-line-number="185"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-185" name="listingsrethinkingpy-185"></a>        <span class="n">mu_str</span> <span class="o">+=</span> <span class="s2">"b_</span><span class="si">{}</span><span class="s2"> * </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="n">predictor</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-186"><code data-line-number="186"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-186" name="listingsrethinkingpy-186"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">mu_str</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-187"><code data-line-number="187"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-187" name="listingsrethinkingpy-187"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"    sigma = pyro.sample('sigma', dist.HalfCauchy(2))"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-188"><code data-line-number="188"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-188" name="listingsrethinkingpy-188"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"    with pyro.plate('plate'):"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-189"><code data-line-number="189"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-189" name="listingsrethinkingpy-189"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"        return pyro.sample('</span><span class="si">{}</span><span class="s2">', dist.Normal(mu, sigma), obs=</span><span class="si">{}</span><span class="s2">)"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-190"><code data-line-number="190"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-190" name="listingsrethinkingpy-190"></a>          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y_node</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span> <span class="n">y_node</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-191"><code data-line-number="191"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-191" name="listingsrethinkingpy-191"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-192"><code data-line-number="192"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-192" name="listingsrethinkingpy-192"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-193"><code data-line-number="193"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-193" name="listingsrethinkingpy-193"></a><span class="k">def</span> <span class="nf">extract_samples</span><span class="p">(</span><span class="n">posterior</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-194"><code data-line-number="194"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-194" name="listingsrethinkingpy-194"></a>    <span class="n">nodes</span> <span class="o">=</span> <span class="n">poutine</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">prune_subsample_sites</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">stochastic_nodes</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-195"><code data-line-number="195"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-195" name="listingsrethinkingpy-195"></a>    <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span><span class="o">.</span><span class="n">support</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-196"><code data-line-number="196"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-196" name="listingsrethinkingpy-196"></a>    <span class="k">return</span> <span class="p">{</span><span class="n">latent</span><span class="p">:</span> <span class="n">samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">for</span> <span class="n">latent</span><span class="p">,</span> <span class="n">samples</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-197"><code data-line-number="197"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-197" name="listingsrethinkingpy-197"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-198"><code data-line-number="198"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-198" name="listingsrethinkingpy-198"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-199"><code data-line-number="199"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-199" name="listingsrethinkingpy-199"></a><span class="k">def</span> <span class="nf">coef</span><span class="p">(</span><span class="n">posterior</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-200"><code data-line-number="200"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-200" name="listingsrethinkingpy-200"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="p">{}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-201"><code data-line-number="201"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-201" name="listingsrethinkingpy-201"></a>    <span class="n">node_supports</span> <span class="o">=</span> <span class="n">extract_samples</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-202"><code data-line-number="202"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-202" name="listingsrethinkingpy-202"></a>    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-203"><code data-line-number="203"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-203" name="listingsrethinkingpy-203"></a>        <span class="n">mean</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-204"><code data-line-number="204"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-204" name="listingsrethinkingpy-204"></a>    <span class="c1"># correct `intercept` due to "centering trick"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-205"><code data-line-number="205"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-205" name="listingsrethinkingpy-205"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">LM</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"Intercept"</span> <span class="ow">in</span> <span class="n">mean</span> <span class="ow">and</span> <span class="n">posterior</span><span class="o">.</span><span class="n">centering</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-206"><code data-line-number="206"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-206" name="listingsrethinkingpy-206"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_get_centering_constant</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-207"><code data-line-number="207"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-207" name="listingsrethinkingpy-207"></a>        <span class="n">mean</span><span class="p">[</span><span class="s2">"Intercept"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean</span><span class="p">[</span><span class="s2">"Intercept"</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-208"><code data-line-number="208"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-208" name="listingsrethinkingpy-208"></a>    <span class="k">return</span> <span class="n">mean</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-209"><code data-line-number="209"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-209" name="listingsrethinkingpy-209"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-210"><code data-line-number="210"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-210" name="listingsrethinkingpy-210"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-211"><code data-line-number="211"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-211" name="listingsrethinkingpy-211"></a><span class="k">def</span> <span class="nf">vcov</span><span class="p">(</span><span class="n">posterior</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-212"><code data-line-number="212"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-212" name="listingsrethinkingpy-212"></a>    <span class="n">node_supports</span> <span class="o">=</span> <span class="n">extract_samples</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-213"><code data-line-number="213"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-213" name="listingsrethinkingpy-213"></a>    <span class="n">packed_support</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">support</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-214"><code data-line-number="214"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-214" name="listingsrethinkingpy-214"></a>                                <span class="k">for</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-215"><code data-line-number="215"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-215" name="listingsrethinkingpy-215"></a>    <span class="n">cov_scheme</span> <span class="o">=</span> <span class="n">WelfordCovariance</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-216"><code data-line-number="216"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-216" name="listingsrethinkingpy-216"></a>    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">packed_support</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-217"><code data-line-number="217"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-217" name="listingsrethinkingpy-217"></a>        <span class="n">cov_scheme</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-218"><code data-line-number="218"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-218" name="listingsrethinkingpy-218"></a>    <span class="k">return</span> <span class="n">cov_scheme</span><span class="o">.</span><span class="n">get_covariance</span><span class="p">(</span><span class="n">regularize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-219"><code data-line-number="219"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-219" name="listingsrethinkingpy-219"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-220"><code data-line-number="220"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-220" name="listingsrethinkingpy-220"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-221"><code data-line-number="221"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-221" name="listingsrethinkingpy-221"></a><span class="k">def</span> <span class="nf">precis</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-222"><code data-line-number="222"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-222" name="listingsrethinkingpy-222"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">TracePosterior</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-223"><code data-line-number="223"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-223" name="listingsrethinkingpy-223"></a>        <span class="n">node_supports</span> <span class="o">=</span> <span class="n">extract_samples</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-224"><code data-line-number="224"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-224" name="listingsrethinkingpy-224"></a>    <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-225"><code data-line-number="225"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-225" name="listingsrethinkingpy-225"></a>        <span class="n">node_supports</span> <span class="o">=</span> <span class="n">posterior</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-226"><code data-line-number="226"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-226" name="listingsrethinkingpy-226"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Mean"</span><span class="p">,</span> <span class="s2">"StdDev"</span><span class="p">,</span> <span class="s2">"|0.89"</span><span class="p">,</span> <span class="s2">"0.89|"</span><span class="p">])</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-227"><code data-line-number="227"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-227" name="listingsrethinkingpy-227"></a>    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">support</span> <span class="ow">in</span> <span class="n">node_supports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-228"><code data-line-number="228"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-228" name="listingsrethinkingpy-228"></a>        <span class="k">if</span> <span class="n">support</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-229"><code data-line-number="229"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-229" name="listingsrethinkingpy-229"></a>            <span class="n">hpdi</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-230"><code data-line-number="230"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-230" name="listingsrethinkingpy-230"></a>            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">support</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">support</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-231"><code data-line-number="231"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-231" name="listingsrethinkingpy-231"></a>                            <span class="n">hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-232"><code data-line-number="232"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-232" name="listingsrethinkingpy-232"></a>        <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-233"><code data-line-number="233"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-233" name="listingsrethinkingpy-233"></a>            <span class="n">support</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">support</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-234"><code data-line-number="234"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-234" name="listingsrethinkingpy-234"></a>            <span class="n">mean</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-235"><code data-line-number="235"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-235" name="listingsrethinkingpy-235"></a>            <span class="n">std</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-236"><code data-line-number="236"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-236" name="listingsrethinkingpy-236"></a>            <span class="n">hpdi</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">hpdi</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-237"><code data-line-number="237"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-237" name="listingsrethinkingpy-237"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-238"><code data-line-number="238"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-238" name="listingsrethinkingpy-238"></a>                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"</span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">std</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-239"><code data-line-number="239"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-239" name="listingsrethinkingpy-239"></a>                                                    <span class="n">hpdi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">hpdi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-240"><code data-line-number="240"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-240" name="listingsrethinkingpy-240"></a>    <span class="c1"># correct `intercept` due to "centering trick"</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-241"><code data-line-number="241"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-241" name="listingsrethinkingpy-241"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">LM</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"Intercept"</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">posterior</span><span class="o">.</span><span class="n">centering</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-242"><code data-line-number="242"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-242" name="listingsrethinkingpy-242"></a>        <span class="n">center</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_get_centering_constant</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">"Mean"</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-243"><code data-line-number="243"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-243" name="listingsrethinkingpy-243"></a>        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Intercept"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"Mean"</span><span class="p">,</span> <span class="s2">"|0.89"</span><span class="p">,</span> <span class="s2">"0.89|"</span><span class="p">]]</span> <span class="o">-=</span> <span class="n">center</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-244"><code data-line-number="244"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-244" name="listingsrethinkingpy-244"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-245"><code data-line-number="245"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-245" name="listingsrethinkingpy-245"></a>    <span class="k">if</span> <span class="n">corr</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-246"><code data-line-number="246"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-246" name="listingsrethinkingpy-246"></a>        <span class="n">cov</span> <span class="o">=</span> <span class="n">vcov</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-247"><code data-line-number="247"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-247" name="listingsrethinkingpy-247"></a>        <span class="n">corr</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">cov</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">ger</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">diag</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-248"><code data-line-number="248"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-248" name="listingsrethinkingpy-248"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-249"><code data-line-number="249"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-249" name="listingsrethinkingpy-249"></a>            <span class="n">df</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-250"><code data-line-number="250"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-250" name="listingsrethinkingpy-250"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-251"><code data-line-number="251"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-251" name="listingsrethinkingpy-251"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">MCMC</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-252"><code data-line-number="252"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-252" name="listingsrethinkingpy-252"></a>        <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">marginal</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-253"><code data-line-number="253"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-253" name="listingsrethinkingpy-253"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-254"><code data-line-number="254"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-254" name="listingsrethinkingpy-254"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-255"><code data-line-number="255"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-255" name="listingsrethinkingpy-255"></a>    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-256"><code data-line-number="256"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-256" name="listingsrethinkingpy-256"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-257"><code data-line-number="257"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-257" name="listingsrethinkingpy-257"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-258"><code data-line-number="258"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-258" name="listingsrethinkingpy-258"></a><span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-259"><code data-line-number="259"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-259" name="listingsrethinkingpy-259"></a>    <span class="n">obs_node</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observation_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-260"><code data-line-number="260"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-260" name="listingsrethinkingpy-260"></a>    <span class="n">mu</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-261"><code data-line-number="261"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-261" name="listingsrethinkingpy-261"></a>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-262"><code data-line-number="262"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-262" name="listingsrethinkingpy-262"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-263"><code data-line-number="263"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-263" name="listingsrethinkingpy-263"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_categorical</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-264"><code data-line-number="264"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-264" name="listingsrethinkingpy-264"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-265"><code data-line-number="265"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-265" name="listingsrethinkingpy-265"></a>            <span class="n">mu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-266"><code data-line-number="266"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-266" name="listingsrethinkingpy-266"></a>    <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-267"><code data-line-number="267"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-267" name="listingsrethinkingpy-267"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-268"><code data-line-number="268"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-268" name="listingsrethinkingpy-268"></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-269"><code data-line-number="269"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-269" name="listingsrethinkingpy-269"></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TracePredictive</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-270"><code data-line-number="270"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-270" name="listingsrethinkingpy-270"></a>                                     <span class="n">posterior</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-271"><code data-line-number="271"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-271" name="listingsrethinkingpy-271"></a>        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">predictive</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-272"><code data-line-number="272"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-272" name="listingsrethinkingpy-272"></a>            <span class="n">mu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-273"><code data-line-number="273"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-273" name="listingsrethinkingpy-273"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-274"><code data-line-number="274"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-274" name="listingsrethinkingpy-274"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-275"><code data-line-number="275"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-275" name="listingsrethinkingpy-275"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-276"><code data-line-number="276"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-276" name="listingsrethinkingpy-276"></a><span class="k">def</span> <span class="nf">sim</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-277"><code data-line-number="277"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-277" name="listingsrethinkingpy-277"></a>    <span class="n">obs_node</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observation_nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-278"><code data-line-number="278"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-278" name="listingsrethinkingpy-278"></a>    <span class="n">obs</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-279"><code data-line-number="279"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-279" name="listingsrethinkingpy-279"></a>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-280"><code data-line-number="280"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-280" name="listingsrethinkingpy-280"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-281"><code data-line-number="281"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-281" name="listingsrethinkingpy-281"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">_categorical</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-282"><code data-line-number="282"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-282" name="listingsrethinkingpy-282"></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">posterior</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-283"><code data-line-number="283"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-283" name="listingsrethinkingpy-283"></a>            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"fn"</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">())</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-284"><code data-line-number="284"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-284" name="listingsrethinkingpy-284"></a>    <span class="k">else</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-285"><code data-line-number="285"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-285" name="listingsrethinkingpy-285"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-286"><code data-line-number="286"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-286" name="listingsrethinkingpy-286"></a>                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-287"><code data-line-number="287"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-287" name="listingsrethinkingpy-287"></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TracePredictive</span><span class="p">(</span><span class="n">poutine</span><span class="o">.</span><span class="n">lift</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-288"><code data-line-number="288"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-288" name="listingsrethinkingpy-288"></a>                                     <span class="n">posterior</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-289"><code data-line-number="289"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-289" name="listingsrethinkingpy-289"></a>        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">predictive</span><span class="o">.</span><span class="n">exec_traces</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-290"><code data-line-number="290"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-290" name="listingsrethinkingpy-290"></a>            <span class="n">obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obs_node</span><span class="p">][</span><span class="s2">"value"</span><span class="p">])</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-291"><code data-line-number="291"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-291" name="listingsrethinkingpy-291"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-292"><code data-line-number="292"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-292" name="listingsrethinkingpy-292"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-293"><code data-line-number="293"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-293" name="listingsrethinkingpy-293"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-294"><code data-line-number="294"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-294" name="listingsrethinkingpy-294"></a><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">posteriors</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-295"><code data-line-number="295"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-295" name="listingsrethinkingpy-295"></a>    <span class="n">post_ics</span> <span class="o">=</span> <span class="p">{}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-296"><code data-line-number="296"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-296" name="listingsrethinkingpy-296"></a>    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-297"><code data-line-number="297"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-297" name="listingsrethinkingpy-297"></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">posteriors</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-298"><code data-line-number="298"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-298" name="listingsrethinkingpy-298"></a>            <span class="n">post_ics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">posteriors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">information_criterion</span><span class="p">(</span><span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-299"><code data-line-number="299"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-299" name="listingsrethinkingpy-299"></a>    <span class="n">n_cases</span> <span class="o">=</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"waic"</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-300"><code data-line-number="300"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-300" name="listingsrethinkingpy-300"></a>    <span class="n">WAIC</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"waic"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">posteriors</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-301"><code data-line-number="301"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-301" name="listingsrethinkingpy-301"></a>    <span class="n">pWAIC</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"p_waic"</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">posteriors</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-302"><code data-line-number="302"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-302" name="listingsrethinkingpy-302"></a>    <span class="n">SE</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">n_cases</span> <span class="o">*</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">"waic"</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">posteriors</span><span class="p">}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-303"><code data-line-number="303"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-303" name="listingsrethinkingpy-303"></a>    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"WAIC"</span><span class="p">:</span> <span class="n">WAIC</span><span class="p">,</span> <span class="s2">"pWAIC"</span><span class="p">:</span> <span class="n">pWAIC</span><span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">"WAIC"</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-304"><code data-line-number="304"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-304" name="listingsrethinkingpy-304"></a>    <span class="n">table</span><span class="p">[</span><span class="s2">"dWAIC"</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">"WAIC"</span><span class="p">]</span> <span class="o">-</span> <span class="n">table</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-305"><code data-line-number="305"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-305" name="listingsrethinkingpy-305"></a>    <span class="n">table</span><span class="p">[</span><span class="s2">"weight"</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">"dWAIC"</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-306"><code data-line-number="306"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-306" name="listingsrethinkingpy-306"></a>    <span class="n">table</span><span class="p">[</span><span class="s2">"SE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">SE</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-307"><code data-line-number="307"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-307" name="listingsrethinkingpy-307"></a>    <span class="n">dSE</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-308"><code data-line-number="308"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-308" name="listingsrethinkingpy-308"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-309"><code data-line-number="309"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-309" name="listingsrethinkingpy-309"></a>        <span class="n">WAIC0</span> <span class="o">=</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">"waic"</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-310"><code data-line-number="310"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-310" name="listingsrethinkingpy-310"></a>        <span class="n">WAICi</span> <span class="o">=</span> <span class="n">post_ics</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s2">"waic"</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-311"><code data-line-number="311"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-311" name="listingsrethinkingpy-311"></a>        <span class="n">dSE</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n_cases</span> <span class="o">*</span> <span class="p">(</span><span class="n">WAICi</span> <span class="o">-</span> <span class="n">WAIC0</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-312"><code data-line-number="312"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-312" name="listingsrethinkingpy-312"></a>    <span class="n">table</span><span class="p">[</span><span class="s2">"dSE"</span><span class="p">]</span> <span class="o">=</span> <span class="n">dSE</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-313"><code data-line-number="313"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-313" name="listingsrethinkingpy-313"></a>    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-314"><code data-line-number="314"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-314" name="listingsrethinkingpy-314"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-315"><code data-line-number="315"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-315" name="listingsrethinkingpy-315"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-316"><code data-line-number="316"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-316" name="listingsrethinkingpy-316"></a><span class="k">def</span> <span class="nf">ensemble</span><span class="p">(</span><span class="n">posteriors</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-317"><code data-line-number="317"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-317" name="listingsrethinkingpy-317"></a>    <span class="n">weighted_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">compare</span><span class="p">(</span><span class="n">posteriors</span><span class="p">)[</span><span class="s2">"weight"</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-318"><code data-line-number="318"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-318" name="listingsrethinkingpy-318"></a>    <span class="n">weighted_num</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">weighted_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-319"><code data-line-number="319"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-319" name="listingsrethinkingpy-319"></a>    <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-320"><code data-line-number="320"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-320" name="listingsrethinkingpy-320"></a>    <span class="n">sims</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-321"><code data-line-number="321"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-321" name="listingsrethinkingpy-321"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">weighted_num</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-322"><code data-line-number="322"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-322" name="listingsrethinkingpy-322"></a>        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">weighted_num</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-323"><code data-line-number="323"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-323" name="listingsrethinkingpy-323"></a>        <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">(</span><span class="n">posteriors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-324"><code data-line-number="324"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-324" name="listingsrethinkingpy-324"></a>        <span class="n">sims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="p">(</span><span class="n">posteriors</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_samples</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-325"><code data-line-number="325"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-325" name="listingsrethinkingpy-325"></a>    <span class="n">num_data</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-326"><code data-line-number="326"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-326" name="listingsrethinkingpy-326"></a>    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">links</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-327"><code data-line-number="327"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-327" name="listingsrethinkingpy-327"></a>    <span class="n">sims</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-328"><code data-line-number="328"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-328" name="listingsrethinkingpy-328"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">"link"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">links</span><span class="p">),</span> <span class="s2">"sim"</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">sims</span><span class="p">)}</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-329"><code data-line-number="329"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-329" name="listingsrethinkingpy-329"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-330"><code data-line-number="330"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-330" name="listingsrethinkingpy-330"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-331"><code data-line-number="331"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-331" name="listingsrethinkingpy-331"></a><span class="k">def</span> <span class="nf">_worker</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">child_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-332"><code data-line-number="332"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-332" name="listingsrethinkingpy-332"></a>    <span class="k">if</span> <span class="n">child_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-333"><code data-line-number="333"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-333" name="listingsrethinkingpy-333"></a>        <span class="n">idx</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">child_info</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-334"><code data-line-number="334"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-334" name="listingsrethinkingpy-334"></a>        <span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-335"><code data-line-number="335"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-335" name="listingsrethinkingpy-335"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-336"><code data-line-number="336"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-336" name="listingsrethinkingpy-336"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-337"><code data-line-number="337"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-337" name="listingsrethinkingpy-337"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">fn_args</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-338"><code data-line-number="338"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-338" name="listingsrethinkingpy-338"></a>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-339"><code data-line-number="339"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-339" name="listingsrethinkingpy-339"></a>        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-340"><code data-line-number="340"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-340" name="listingsrethinkingpy-340"></a>        <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-341"><code data-line-number="341"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-341" name="listingsrethinkingpy-341"></a>        <span class="n">event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-342"><code data-line-number="342"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-342" name="listingsrethinkingpy-342"></a>    <span class="k">return</span> <span class="n">result</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-343"><code data-line-number="343"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-343" name="listingsrethinkingpy-343"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-344"><code data-line-number="344"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-344" name="listingsrethinkingpy-344"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-345"><code data-line-number="345"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-345" name="listingsrethinkingpy-345"></a><span class="k">def</span> <span class="nf">replicate</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">mc_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-346"><code data-line-number="346"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-346" name="listingsrethinkingpy-346"></a>    <span class="n">mc_cores</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">mc_cores</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mc_cores</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-347"><code data-line-number="347"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-347" name="listingsrethinkingpy-347"></a>    <span class="n">queue</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-348"><code data-line-number="348"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-348" name="listingsrethinkingpy-348"></a>    <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mc_cores</span><span class="p">)]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-349"><code data-line-number="349"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-349" name="listingsrethinkingpy-349"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-350"><code data-line-number="350"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-350" name="listingsrethinkingpy-350"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mc_cores</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-351"><code data-line-number="351"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-351" name="listingsrethinkingpy-351"></a>        <span class="n">n_i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">//</span> <span class="n">mc_cores</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">%</span> <span class="n">mc_cores</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-352"><code data-line-number="352"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-352" name="listingsrethinkingpy-352"></a>        <span class="n">child_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">queue</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-353"><code data-line-number="353"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-353" name="listingsrethinkingpy-353"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">n_i</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fn_args</span><span class="p">,</span> <span class="n">child_info</span><span class="p">),</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-354"><code data-line-number="354"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-354" name="listingsrethinkingpy-354"></a>        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-355"><code data-line-number="355"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-355" name="listingsrethinkingpy-355"></a>        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-356"><code data-line-number="356"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-356" name="listingsrethinkingpy-356"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-357"><code data-line-number="357"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-357" name="listingsrethinkingpy-357"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-358"><code data-line-number="358"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-358" name="listingsrethinkingpy-358"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-359"><code data-line-number="359"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-359" name="listingsrethinkingpy-359"></a>        <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-360"><code data-line-number="360"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-360" name="listingsrethinkingpy-360"></a>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-361"><code data-line-number="361"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-361" name="listingsrethinkingpy-361"></a>        <span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-362"><code data-line-number="362"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-362" name="listingsrethinkingpy-362"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-363"><code data-line-number="363"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-363" name="listingsrethinkingpy-363"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mc_cores</span><span class="p">):</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-364"><code data-line-number="364"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-364" name="listingsrethinkingpy-364"></a>        <span class="n">processes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#listingsrethinkingpy-365"><code data-line-number="365"></code></a></td>
<td class="code"><code><a id="listingsrethinkingpy-365" name="listingsrethinkingpy-365"></a>    <span class="k">return</span> <span class="n">result</span>
</code></td>
</tr>
</table></div>

        <!--End of body content-->

        <footer id="footer"><div class="text-center">
  Contents © 2025         <a href="mailto:fehiepsi@gmail.com">Du Phan</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
  <img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"></a>

</div>

            
            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131299125-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-131299125-1');
</script>
</body>
</html>
